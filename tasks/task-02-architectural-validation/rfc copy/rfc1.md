# Резюме
*Вынести населённые пункты в отдельный справочник, определить для каждой пиццерии принадлежность к населённому пункту*
# Мотивация, задача
Для больших стран, где пиццерий много, требуется фильтрация в том числе и по нас пункту. Не всегда достаточно получить данные по департаменту. В одном населённом пункте могут действовать несколько сетей партнёров. Потому нам необходимо иметь ещё одну сущность, которая более точно скажет нам, где территориально находится пиццерия, какие ещё рядом есть пиццерии. Сейчас мы используем либо идентификатор населённого пункта из старой адресной системы, либо пытаемся мапить название населённого пункта из нового адреса, сопоставляя ему значение населённого пункта из справочника в Додо ИС.
# Описание
В старой адресной системе для указания адреса требовалось указать и нас пункт. Это информация использовалась в том числе и для определения зоны доставки. С релизом новой адресной системы пропала необходимость поддерживать функционал с добавлением типов улиц, самих улиц и домов. НО, в новом адресе не всегда присутствует значение населённого пункта, а даже если присутствует, по нему сложно проводить поиск, так как это строковое значение, которое храниться как поле в json-объекте.
Что предлагается сделать
1. Вынести справочник населённых пунктов в datacatalog.
  - Id
  - LocalityName (уникальное имя)
  - TransliteAlias (уникальный алиас)
  - Region
  - IsPublic
  - кто, когда создал/редактировал (стандартные поля как у всех)
  - Version (обсуждаемо)
  - CountryId
    Не вижу смысла делать привязку к бизнесу. Выглядит так, что эта сущность уникальная только в рамках страны. Скорее всего потребуется событие (обсуждаемо). Ещё под вопросом тип населённого пункта (город, посёлок, деревня, район и т.д.), может быть признак, является ли нас пункт областным центром, например.
2. Пересобрать страницу добавление нового населённого пункта, предусмотрев возможность скрывать населённый пункт из публичного доступа
3. Добавить к юниту (нас интересуют пиццерии/кофейни Store и ПРЦ DistributionCenters) новое поле Uuid? LocalityId
4. [обсуждаемо] В момент добавления нового юнита (пиццерия/ПРЦ) делать запрос к datacatalog с попыткой найти нужный нас пункт для нового юнита по полученному адресу. Если нас пункт находится по названию, добавить в сформированный объект данное значение и сохранить его в базу. Если же соответствие найти не получилось, сохранить новый юнит с null в качестве LocalityId.
5. В любом случае у нас должен быть инструмент ручной привязки юнита к нас пункту. Во-первых, нас пункт может поменяться (мы недавно встречали такой кейс с Коммунаркой, где поселёок Коммунарка был объединён с другими посёлками в район). Во-вторых, нас пункта может и не быть в нашем справочнике и/или мы не смогли сопоставить название. Сейчас у нас имеется страница для определения департамента по умолчанию для нас пункта и привязка любого департамента к нас пункту.
6. Для контроля, чтобы быть уверенным, что у пиццерии указан нас пункт, можно добавить в список открытия юнита доп пункт, который будет проверять, привязан ли юнит к нас пункту. Тем самым, мы будем уверены, что любой новый юнит (пиццерия) будет привязана к своему нас пункту.
Для действующих пиццерий/ПРЦ потребуется миграция данных
# Недостатки
*Я не вижу на данный момент, что мы можем ухудшить. Сейчас реальность такова, что старая адресная система функционирует параллельно с новой адресной системой (при заведении/редактировании юнита требуется вводить два адреса). Одна из проблем, почему старая адресная система всё ещё с нами, это необходимость некоторым нашим системам использовать населённые пункты.*
# Обоснование и альтернативы
Испытываем трудности в найме. Если взять для примера РФ, то при посещении ресурса rabotavdodo.ru мы пытаемся либо определить местоположение пользователя (что, кстати, может и не совпадать с его фактическим местом проживания), либо даём выбрать предпочтительный населённый пункт из списка. Для выбранного насёленного пункта мы получаем точки, для которых запрашиваем вакансии. Мы не хотим отказываться от сущности населённого пункта, так как это упрощает жизнь самому пользователю и он может просматривать данные только по интересующим его пиццериям/прц. Также очень важно оставить возможность просматривать вакансии по всем точкам в населённом пункте, так как в разных точках требуются разные сотрудники.
Также населённые пункты требуются на сайте пиццы. Первое, траслитерация названия используется в адресной строке, что позволяет показывать клиенту доступное меню на странице. Меню берётся по ресторанам и тут важно понимать, что в одном населённом пункте может быть несколько сетей пиццерий разных партнёров. Если поиск пиццерии можно организовать, используя адрес пиццерии, то запрос меню для населённого пункта, в котором находится клиент, становится проблематичным.
Если говорить про аналитику, то наверняка часть данных проще фильтровать по областям, округам и т.д.
Альтернативные решения не рассматривались, так как их особо и нет. Если отказаться от сущности населённого пункта, то у нас пропадает возможность объединять пиццерии(кофейни)/ПРЦ по территориальному признаку. Можно рассмотреть вариант фильтрации по названию населённого пункта из адреса, который приходит от YandexMap/GoogleMap, но, к сожалению, не у всех пиццерий есть название населённого пункта в адресе (процент маленький, но такие пиццерии есть среди действующих и могу появляться, исправление по запросу, что даёт временную задержку, в которую тот же найм не будет вестись в пиццерию). Кажется, что полагаться на внешний сервис — ненадёжное решение.
Второй момент — карта и геоданные не универсальное решение. Определение по геоданным пользователя — это ограничение по некоторому радиусу + вероятность того, что гео пользователя будет определено неверно достаточно высокая. Карту не пропихнёшь в решения типа телеграм-бот. 
UPD 24/09/2025 Есть вариант получать геоданные от введённого адреса пользователя и/или он шарит свои гео нам. По гео пользователя можно найти ближайшую точку, а по точке найти департамент и взять все точки департамента. Минус: такое решение не сильно работает, например, для Мск. Второй минус: если человек находится временно в другом месте, мы ему предложим нерелевантные данные.
# История и предшественники
-
# Вопросы на обсуждение
*Может ли решить все проблемы с определением местоположения пиццерии в границах населённого пункта сервис geolocator? Как?
Хотим ли мы расширять функционал geolocator'а функционалом, который не относится как к таковому к гео (нам нужен объединяющий признак для пиццерий(кофеен) и ПРЦ без привязки к зоне доставки — у кофеен нет зоны доставки, ПРЦ также работают без зоны доставки, а найм требуется везде и всегда)*
*Если идти в сторону определения по гео, то потребуется определение значения радиуса, который, теоретически, будет зависеть от размера нас пункта — как узнать это число? Более простое решение — константное значение. Но такое решение сделает систему чуть "туповатой", а мы вроде как хотим "умную" систему, которая делает многое за клиента*
*Что out of scope данного решения?*
# Затрагиваемые сервисы
*datacatalog, dodois, pizza-site, applicants (найм)*
# Комментарии/возражения (вписываются после публикации в #architecture)
### *Иван Иванов:*
Данный RFC приводит к тем же проблемам, из-за которых решили отказываться от собственной адресной системы. Повторю основной на мой взгляд тезис из обсуждения, что ведение и поддержание геоданных не является нашим бизнесом, поэтому лучше воспользоваться сторонним managed решением, которое у нас уже внедрено. Мы сейчас можем брать компонент адреса нужного нам административного уровня по уже занесённым координатам.
