# Резюме
Разработка системы динамических ролей на базе ReBAC (Google Zanzibar)
# Мотивация, задача
Хотим получить систему авторизации, которая позволит комбинировать любой набор бизнесов/стран/департаментов/юнитов + действий и их комбинаций. Это позволит перейти к единым учёткам.
У OAuth приложений не существует разграничений прав доступа, кроме как через scope. В систему динамических ролей можно заложить возможность выдавать права приложениям.
Текущая система передаёт все данные в токене пользователя, либо требует интроспекции.
# Описание
### Текущая система ролей
Существует пользователь, к нему привязана объектная роль.
Объектная роль состоит из
- Uuid пользователя к которому она относится
- Типа объекта, к которому она принадлежит (Страна/Департмент/Юнит)
- Uuid объекта, к которому она относится
- Id роли
Система объектных ролей в текущем виде была унаследована от "старого" сервиса аутентификации. На неё "заточена" вся DodoIS. Переезд на альтернативное решение - это один из технических челенжей (большой объём работы).
К недостаткам можно отнести
-  невозможность выдать роли OAuth приложениям
- отсутствие возможности "различать" одинаковые страны разных бизнесов (справедливости ради - текущая система объектных ролей создавалась во времена когда не было дринкита и донера/кебстера и в условиях разных стран одного бизнеса она в целом работоспособна) => невозможно комбинировать роли уровня страны в разных бизнесах
- отсутствие возможности выдать роль на конкретный бизнес
- роли фиксированы (int32 значения в enum, 47 штук) => добавление новой роли требует обновления контрактов (чтобы auth, UI управления ролями и сервисы "научились" работать с новыми ролями) => медленный процесс, требующий правки многих компонентов (контрактов, ауса, админки пользователей и конечных сервисов где нужны новые роли).
- иерархию "наследования" ролей необходимо проверять в каждом оконечном сервисе (чтобы например понять на какие юниты распространяется роль уровня страны - необходимо "скачать" все юниты из датакаталога и найти там те что относятся к конкретной стране)
### Предлагаемая система ролей
Она гибче, но сложнее существующей.
Основные компоненты:
- Owner ("владелец" объектной роли - Пользователь или OAuth приложение)
- Элемент орг.структуры (может содержать родительский элемент орг.структуры, вложенность может быть произвольной)
- Фича (по сути - просто произвольно-именованный идентификатор набора функционала DodoIS). Подразумевается что количество фич будет исчисляться тысячами.
- Динамическая роль - динамически создаваемый именованный набор фич (в 1 роли может быть произвольное количество фич, одна и та же фича может входить в разные динамические роли)
- Разрешение - связь между Owner, Элементом орг.структуры и Динамической ролью
Плюсы:
- Текущая система объектных ролей полностью выразима в системе динамических ролей (можно сделать плавный переезд)
- Можно выдавать роли любому Owner'у - будь то пользователь, OAuth приложение или что-то ещё
- Можно динамически добавлять фичи
- Можно динамически группировать фичи в роли произвольным образом
- Можно выдавать роли на произвольные объекты орг.структуры, при этом сама орг.структура может иметь любую иерархию
- Централизованный контроль прав
- Мгновенная реакция на отзыв доступа
- Более тонкая "нарезка" функционала DodoIS
Подразумевается использование готового решения в качетсве "фундамента" такой системы.
Текущие варианты:
- [SpiceDB ](https://github.com/authzed/spicedb)
- [OpenFGA](https://github.com/openfga/openfga)
"Поверх" готового решения будет создано API, в которое будут обращаться все сервисы для авторизации доступа. Примеры запросов
- Получить список юнитов конерктной страны или бизнеса где есть фича X
- Получить список фич конкретного юнита
- Проверить есть ли у пользователя одна из фич X, Y, Z на юнит A
- Получить список стран в конкретном бизнесе, на где есть фича X
# Недостатки
Долгострой.
Единая точка отказа.
Зависимость от внешних компонентов.
Высокие требования к производительности.

